name: Project8 CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement'
        type: choice
        options: ['dev', 'production']
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Load cached venv
      id: cached-uv-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/uv.lock') }}

    - name: Install dependencies
      run: uv sync

    - name: Run tests with pytest
      run: |
        uv run pytest tests/ --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing --cov-fail-under=70 -v

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Check API coverage specifically
      run: |
        echo "ðŸ“Š VÃ©rification de la couverture de l'API..."
        uv run pytest tests/api/ -v \
          --cov=src/api \
          --cov-report=term-missing \
          --cov-report=json:coverage-api.json \
          --cov-fail-under=80

    - name: Display API coverage summary
      if: always()
      run: |
        if [ -f coverage-api.json ]; then
          echo "==================================================="
          echo "ðŸ“ˆ RÃ©sumÃ© de la couverture de l'API"
          echo "==================================================="
          python3 << 'PYTHON_SCRIPT'
        import json
        with open('coverage-api.json') as f:
            data = json.load(f)
        total = data['totals']['percent_covered']
        print(f'Couverture totale API: {total:.2f}%')
        print('')
        print('DÃ©tail par fichier:')
        for file, stats in data['files'].items():
            if 'src/api' in file:
                pct = stats['summary']['percent_covered']
                print(f'  {file}: {pct:.2f}%')
        PYTHON_SCRIPT
          echo "==================================================="
        fi

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.13"

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install dependencies
      run: uv sync

    - name: Run flake8
      run: uv run flake8 ./src

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.13"

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install dependencies
      run: uv sync

  deploy:
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: github.ref == 'refs/heads/main' &&  github.event.inputs.environment == 'production'
    environment: production  # NÃ©cessite approbation dans Settings > Environments

    steps:
    - name: Setup Git LFS
      run: |
        git lfs install

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Pull LFS files
      run: git lfs pull

    - name: Push to Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
      run: |
        echo "Configuration Git pour HF"
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        echo "Ajouter remote HF si pas dÃ©jÃ  prÃ©sent"
        if ! git remote | grep -q huggingface; then
          git remote add huggingface https://huggingface.co/spaces/$HF_SPACE_NAME
        fi

        echo "CrÃ©er une branche orpheline pour Ã©viter l'historique"
        git checkout --orphan deploy-hf

        echo "Configuration Git LFS pour HuggingFace"
        git lfs track "*.pkl"

        echo "Copier le Dockerfile pour HF Spaces (API + UI Gradio + Redis)"
        cp docker/Dockerfile.hf Dockerfile

        echo "Copier le README pour HF Spaces avec metadata"
        cp docs/README_HF.md README.md

        echo "Suppression des donnÃ©es non nÃ©cessaires en production"
        git rm -f *.pdf 2>/dev/null || true
        git rm -rf docs 2>/dev/null || true
        git rm -rf sql 2>/dev/null || true
        git rm -rf tests 2>/dev/null || true
        git rm -rf docker 2>/dev/null || true
        git rm -f docker-compose.yml 2>/dev/null || true

        echo "Ajouter tous les fichiers nÃ©cessaires (y compris LFS)"
        git add -A
        git commit -m "Deploy to HuggingFace Spaces: API FastAPI + UI Gradio"

        echo "Push vers HF avec authentification (LFS supportÃ©)"
        git push https://oauth2:$HF_TOKEN@huggingface.co/spaces/$HF_SPACE_NAME deploy-hf:main --force

        