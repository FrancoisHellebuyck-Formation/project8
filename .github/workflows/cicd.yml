name: Project8 CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement'
        type: choice
        options: ['dev', 'production']
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Load cached venv
      id: cached-uv-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/uv.lock') }}

    - name: Install dependencies
      run: uv sync

    - name: Run tests with pytest
      run: |
        uv run pytest tests/ --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing --cov-fail-under=80 -v

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.13"

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install dependencies
      run: uv sync

    - name: Run flake8
      run: uv run flake8 ./src

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.13"

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install dependencies
      run: uv sync

  deploy:
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: github.ref == 'refs/heads/main' &&  github.event.inputs.environment == 'production'
    environment: production  # N√©cessite approbation dans Settings > Environments
    
    steps:
    - name: Setup Git LFS
      run: |
        git lfs install

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        lfs: true

    - name: Pull LFS files
      run: git lfs pull

    - name: Push to Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
      run: |
        echo "Configuration Git pour HF"
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        echo "Ajouter remote HF si pas d√©j√† pr√©sent"
        if ! git remote | grep -q huggingface; then
          git remote add huggingface https://huggingface.co/spaces/$HF_SPACE_NAME
        fi

        echo "Cr√©er une branche orpheline pour √©viter l'historique"
        git checkout --orphan deploy-hf

        echo "Configuration Git LFS pour HuggingFace"
        git lfs track "*.pkl"

        echo "Copier le Dockerfile pour HF Spaces (API + UI Gradio + Redis)"
        cp docker/Dockerfile.hf Dockerfile

        echo "Cr√©er README.md pour HF Spaces avec metadata"
        cat > README.md << 'EOF'
---
title: Lung Cancer Prediction
emoji: ü´Å
colorFrom: green
colorTo: red
sdk: docker
app_port: 7860
pinned: false
license: mit
---

# ü´Å Lung Cancer Prediction - MLOps Project

Application de pr√©diction de cancer du poumon avec interface Gradio et API FastAPI.

## üéØ Fonctionnalit√©s

- **üé® Interface Gradio** : Interface utilisateur intuitive avec barre de progression color√©e
- **üìä API REST FastAPI** : Endpoints `/predict`, `/predict_proba`, `/health`, `/logs`
- **ü§ñ Mod√®le ML LightGBM** : Mod√®le optimis√© avec feature engineering automatique
- **üìà Feature Engineering** : 15 features d'entr√©e ‚Üí 29 features totales (14 d√©riv√©es)
- **üìù Logs Redis** : Syst√®me de logging persistant avec Redis in-memory (256MB)

## üöÄ Utilisation

### Interface Gradio (Port 7860)

L'interface Gradio est accessible directement sur le port principal. Elle permet de :
- Saisir les informations du patient (√¢ge, genre, sympt√¥mes)
- Obtenir une pr√©diction visuelle avec barre de probabilit√©
- Visualiser le risque : FAIBLE üü¢ / MOD√âR√â üü† / √âLEV√â üî¥

### API REST (Port 8000)

L'API FastAPI tourne en arri√®re-plan et peut √™tre appel√©e directement :

**Endpoints disponibles :**
- `GET /` : Informations sur l'API
- `GET /health` : √âtat de sant√© de l'API
- `POST /predict` : Pr√©diction binaire (0 ou 1)
- `POST /predict_proba` : Pr√©diction avec probabilit√©s
- `GET /logs` : R√©cup√©rer les logs (limite configurable)
- `DELETE /logs` : Supprimer les logs

**Exemple de requ√™te :**
```bash
curl -X POST "http://localhost:8000/predict" \
  -H "Content-Type: application/json" \
  -d '{
    "AGE": 65,
    "GENDER": 1,
    "SMOKING": 1,
    "ALCOHOL CONSUMING": 1,
    "PEER_PRESSURE": 0,
    "YELLOW_FINGERS": 1,
    "ANXIETY": 0,
    "FATIGUE": 1,
    "ALLERGY": 0,
    "WHEEZING": 1,
    "COUGHING": 1,
    "SHORTNESS OF BREATH": 1,
    "SWALLOWING DIFFICULTY": 0,
    "CHEST PAIN": 1,
    "CHRONIC DISEASE": 0
  }'
```

## üìã Features du mod√®le

**15 features d'entr√©e :**
- AGE, GENDER, SMOKING, ALCOHOL CONSUMING, PEER_PRESSURE
- YELLOW_FINGERS, ANXIETY, FATIGUE, ALLERGY
- WHEEZING, COUGHING, SHORTNESS OF BREATH
- SWALLOWING DIFFICULTY, CHEST PAIN, CHRONIC DISEASE

**14 features d√©riv√©es (automatiques) :**
- HIGH_RISK_PROFILE, AGE_SQUARED, TOTAL_SYMPTOMS
- RESPIRATORY_SYMPTOMS, CANCER_TRIAD, SMOKER_WITH_RESP_SYMPTOMS
- ADVANCED_SYMPTOMS, SYMPTOMS_PER_AGE, AGE_RISK_INTERACTION
- MALE_SMOKER, SYMPTOM_INTENSITY, RESPIRATORY_DISTRESS
- CHRONIC_SMOKER_SYMPTOMS, SYMPTOM_DIVERSITY

## ‚öôÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Hugging Face Space Container         ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ   Gradio UI (Port 7860)      ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ Interface publique
‚îÇ  ‚îÇ   (Frontend)                 ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ               ‚îÇ localhost HTTP        ‚îÇ
‚îÇ               ‚Üì                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ   FastAPI (Port 8000)        ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ   (Backend)                  ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ               ‚îÇ                        ‚îÇ
‚îÇ               ‚Üì                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ   Redis (Port 6379)          ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ   (In-Memory Logs)           ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ               ‚Üë                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ   LightGBM Model             ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ   (ML Engine)                ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üèóÔ∏è Technologies

- **Python 3.13+** : Langage principal
- **FastAPI** : Framework API REST
- **Gradio** : Interface utilisateur interactive
- **LightGBM** : Algorithme de machine learning
- **Redis** : Base de donn√©es in-memory pour les logs
- **Pydantic v2** : Validation des donn√©es
- **Scikit-learn** : Pipeline ML
- **Docker** : Containerisation
- **pytest** : Tests unitaires (83% coverage)

## üìö Documentation

- **Documentation API** : Disponible via `/docs` (Swagger UI)
- **Tests** : 126 tests unitaires avec 83% de couverture
- **CI/CD** : GitHub Actions avec tests automatiques
- **Code Quality** : Flake8 compliant (88 char max)

## ‚ö†Ô∏è Avertissement

Cette application est √† **but √©ducatif uniquement** et ne remplace pas un diagnostic m√©dical professionnel. Les pr√©dictions doivent √™tre interpr√©t√©es par un professionnel de sant√© qualifi√©.

## üìÑ Licence

MIT License - Projet OpenClassrooms MLOps (Partie 2/2)

---

**D√©velopp√© avec ‚ù§Ô∏è dans le cadre du parcours MLOps OpenClassrooms**
EOF

        echo "Suppression des donn√©es non n√©cessaires en production"
        git rm -f *.pdf 2>/dev/null || true
        git rm -rf docs 2>/dev/null || true
        git rm -rf sql 2>/dev/null || true
        git rm -rf tests 2>/dev/null || true
        git rm -rf docker 2>/dev/null || true
        git rm -f docker-compose.yml 2>/dev/null || true

        echo "Ajouter tous les fichiers n√©cessaires (y compris LFS)"
        git add -A
        git commit -m "Deploy to HuggingFace Spaces: API FastAPI + UI Gradio"

        echo "Push vers HF avec authentification (LFS support√©)"
        git push https://oauth2:$HF_TOKEN@huggingface.co/spaces/$HF_SPACE_NAME deploy-hf:main --force

      